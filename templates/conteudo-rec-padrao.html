{% extends "conteudo-base.html" %}

{% block title %}Módulo 3: Reconhecimento de Padrões{% endblock %}

{% block content_title %}Módulo 3: Reconhecimento de Padrões: Encontrando Similaridades{% endblock %}

{% block content %}
    {% set MODULO_SLUG = 'rec_padrao' %}
    {% set MIN_ACERTOS = 3 %}
    
    <div id="statusContainer" class="p-4 rounded-lg shadow-md mb-6 bg-yellow-100 border-l-4 border-yellow-500">
        <p class="font-semibold text-gray-700">Seu Progresso de Exercícios:</p>
        <p class="text-xl text-primary-indigo">
            <span id="currentAcertos">{{ progresso_modulo.acertos }}</span> / {{ MIN_ACERTOS }} Acertos para Desbloquear o Módulo 4.
        </p>
        <p class="text-sm text-gray-500 mt-1">
            (Total Acertos: <span id="acertosCount">{{ progresso_modulo.acertos }}</span> | Total Erros: <span id="errosCount">{{ progresso_modulo.erros }}</span>)
        </p>
        <div id="globalFeedback" class="mt-3 hidden p-2 rounded text-white font-medium"></div>
    </div>
    
    <div class="content-section">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-video mr-3"></i> Vídeo Aula: Identificando Semelhanças
        </h2>
        <div class="video-container">
            <iframe src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
        <p class="text-gray-500 mt-4">Encontrar padrões em dados e eventos é o primeiro passo para criar soluções genéricas e eficientes.</p>
    </div>

    <div class="content-section">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-file-alt mr-3"></i> Material de Apoio (PDF)
        </h2>
        <p class="text-gray-700 mb-4">Guia sobre a aplicação de padrões comportamentais e de desempenho em sala de aula.</p>
        <a href="#" class="bg-secondary-green hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg inline-flex items-center transition duration-200">
            <i class="fas fa-download mr-2"></i> Baixar Padrões Pedagógicos
        </a>
    </div>

    <div class="content-section">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-clipboard-check mr-3"></i> Exercícios de Fixação
        </h2>
        <div class="space-y-6">
            
            <div id="q-mod3-1" class="exercise-block border p-4 rounded-lg bg-white shadow" data-question-id="q-mod3-1">
                <p class="font-semibold text-sm mb-2 text-gray-500">Conceito Chave</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">1. Por que a identificação de padrões é crucial após a decomposição de um problema?</p>
                <div class="space-y-2" id="options-q-mod3-1">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-1', 'A', this)" data-answer="A" data-correct="false">
                        A) Para re-dividir o problema em etapas ainda menores.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-1', 'B', this)" data-answer="B" data-correct="true">
                        B) Para criar soluções genéricas que podem ser aplicadas a várias subtarefas semelhantes.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-1', 'C', this)" data-answer="C" data-correct="false">
                        C) Para garantir que o problema não tenha detalhes irrelevantes.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-1', 'D', this)" data-answer="D" data-correct="false">
                        D) Para gerar o algoritmo final sem precisar de mais etapas.
                    </div>
                </div>
                <div id="feedback-q-mod3-1" class="feedback-message mt-4 hidden"></div>
            </div>
            
            <div id="q-mod3-2" class="exercise-block border p-4 rounded-lg bg-white shadow" data-question-id="q-mod3-2">
                <p class="font-semibold text-sm mb-2 text-gray-500">Aplicação Pedagógica</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">2. Em um conjunto de provas de matemática, 80% dos alunos cometeram erros na mesma fórmula. Qual ação demonstra o reconhecimento e uso eficiente deste padrão?</p>
                <div class="space-y-2" id="options-q-mod3-2">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-2', 'A', this)" data-answer="A" data-correct="false">
                        A) Criar 10 provas diferentes para evitar que os alunos copiem as respostas.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-2', 'B', this)" data-answer="B" data-correct="false">
                        B) Devolver as provas e pedir que cada aluno revise seus próprios erros.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-2', 'C', this)" data-answer="C" data-correct="false">
                        C) Explicar aos alunos o conceito fundamental por trás da fórmula, ignorando a parte prática.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-2', 'D', this)" data-answer="D" data-correct="true">
                        D) Interromper a próxima aula para fazer uma revisão coletiva focada apenas na aplicação correta daquela fórmula.
                    </div>
                </div>
                <div id="feedback-q-mod3-2" class="feedback-message mt-4 hidden"></div>
            </div>
            
            <div id="q-mod3-3" class="exercise-block border p-4 rounded-lg bg-white shadow" data-question-id="q-mod3-3">
                <p class="font-semibold text-sm mb-2 text-gray-500">Relação entre Pilares</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">3. A principal função do Reconhecimento de Padrões é servir de ponte para qual pilar subsequente do Pensamento Computacional?</p>
                <div class="space-y-2" id="options-q-mod3-3">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-3', 'A', this)" data-answer="A" data-correct="false">
                        A) Decomposição (volta ao início)
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-3', 'B', this)" data-answer="B" data-correct="false">
                        B) Algoritmos (é o resultado final, não a ponte imediata)
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-3', 'C', this)" data-answer="C" data-correct="true">
                        C) Abstração (padrões são abstraídos em conceitos e modelos)
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-3', 'D', this)" data-answer="D" data-correct="false">
                        D) Otimização (é um resultado da aplicação, não o pilar)
                    </div>
                </div>
                <div id="feedback-q-mod3-3" class="feedback-message mt-4 hidden"></div>
            </div>

            <div id="q-mod3-4" class="exercise-block border p-4 rounded-lg bg-white shadow" data-question-id="q-mod3-4">
                <p class="font-semibold text-sm mb-2 text-gray-500">Tipos de Padrão</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">4. Ao analisar o desempenho de um time de basquete, o técnico percebe que a equipe sempre perde quando joga fora de casa às sextas-feiras. Este é um exemplo de que tipo de padrão?</p>
                <div class="space-y-2" id="options-q-mod3-4">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-4', 'A', this)" data-answer="A" data-correct="false">
                        A) Padrão Geométrico (focado em formas e espaços)
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-4', 'B', this)" data-answer="B" data-correct="false">
                        B) Padrão Estrutural (focado na composição física)
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-4', 'C', this)" data-answer="C" data-correct="true">
                        C) Padrão Temporal/Comportamental (focado no tempo e nas ações)
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-4', 'D', this)" data-answer="D" data-correct="false">
                        D) Anti-padrão (é um padrão negativo, mas ainda se enquadra em um tipo)
                    </div>
                </div>
                <div id="feedback-q-mod3-4" class="feedback-message mt-4 hidden"></div>
            </div>

            <div id="q-mod3-5" class="exercise-block border p-4 rounded-lg bg-white shadow" data-question-id="q-mod3-5">
                <p class="font-semibold text-sm mb-2 text-gray-500">Terminologia</p>
                <p class="font-semibold text-lg mb-4 text-gray-800">5. A fase de Reconhecimento de Padrões é essencialmente a busca por:</p>
                <div class="space-y-2" id="options-q-mod3-5">
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-5', 'A', this)" data-answer="A" data-correct="false">
                        A) Múltiplos caminhos de solução para cada sub-problema.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-5', 'B', this)" data-answer="B" data-correct="false">
                        B) O detalhe mais irrelevante para ser removido na próxima fase.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-5', 'C', this)" data-answer="C" data-correct="false">
                        C) Uma única instrução passo a passo para resolver o problema inicial.
                    </div>
                    <div class="quiz-option bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200"
                        onclick="submitExercise('q-mod3-5', 'D', this)" data-answer="D" data-correct="true">
                        D) Semelhanças, repetições e características comuns entre as sub-partes do problema.
                    </div>
                </div>
                <div id="feedback-q-mod3-5" class="feedback-message mt-4 hidden"></div>
            </div>
            
        </div>
    </div>

    <div class="content-section border-4 border-indigo-200 bg-indigo-50">
        <h2 class="text-2xl font-semibold text-primary-indigo mb-4 flex items-center">
            <i class="fas fa-lightbulb mr-3"></i> Questão de Projeto: Detalhando o Padrão
        </h2>
        <p class="text-gray-700 mb-4">Dentro das etapas que você decompos no Módulo 2, identifique um padrão (repetição de ação ou comportamento) que ocorre em pelo menos duas dessas etapas. Como este padrão pode ser padronizado?</p>
        
        <form id="project-idea-form" onsubmit="handleProjectIdeaSubmission(event, '{{ MODULO_SLUG }}'); return false;">
            <label for="project_idea_2" class="block text-gray-800 font-medium mb-2">Padrões Identificados no seu Projeto:</label>
            <textarea id="project_idea_2" name="project_idea_2" rows="4" class="w-full p-3 border border-indigo-300 rounded-lg focus:ring-primary-indigo focus:border-primary-indigo" placeholder="Ex: O passo 'Coleta de Dados' se repete na Fase 1 (Pesquisa Inicial) e na Fase 3 (Teste de Protótipo). O padrão é a Ação 'Registrar Resultados'. Padronização: Criar um formulário único para todos os registros.">{{ projeto_idea.rec_padrao if projeto_idea.rec_padrao is defined }}</textarea>
            
            <button type="submit" id="projectSubmitBtn" class="mt-4 bg-primary-indigo hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200">Salvar Padrão</button>
            <div id="projectFeedback" class="mt-2 hidden p-2 rounded text-sm font-medium"></div>
        </form>
    </div>
{% endblock %}

{% block finish_button %}
    <div class="mt-8 text-center">
        {% if progresso_modulo.acertos >= MIN_ACERTOS %}
        <form method="POST" action="{{ url_for('concluir_modulo', modulo_nome=MODULO_SLUG) }}">
            <button type="submit" class="btn-finish hover:shadow-lg">
                <i class="fas fa-check-double mr-2"></i>Próximo Módulo (Desbloqueado!)
            </button>
        </form>
        {% else %}
        <button type="button" class="btn-finish-disabled bg-gray-400 text-gray-100 cursor-not-allowed">
            <i class="fas fa-lock mr-2"></i> Próximo Módulo (Requer {{ MIN_ACERTOS }} acertos)
        </button>
        {% endif %}
    </div>
{% endblock %}

{% block custom_scripts %}
<script>
    // Variáveis globais obtidas do Jinja
    const MODULO_SLUG = '{{ MODULO_SLUG }}';
    const MIN_ACERTOS = {{ MIN_ACERTOS }};

    // Referências aos elementos de progresso
    const currentAcertosSpan = document.getElementById('currentAcertos');
    const acertosCountSpan = document.getElementById('acertosCount');
    const errosCountSpan = document.getElementById('errosCount');
    const globalFeedbackDiv = document.getElementById('globalFeedback');
    const finishButtonContainer = document.querySelector('.mt-8.text-center');

    // Mapeamento de feedback para cor de Tailwind CSS
    const feedbackClasses = {
        'success': 'bg-green-500',
        'warning': 'bg-yellow-500',
        'error': 'bg-red-500',
        'info': 'bg-blue-500'
    };

    // Função para atualizar os contadores e o botão no topo da página
    function updateProgressUI(newAcertos, newErros) {
        currentAcertosSpan.textContent = newAcertos;
        acertosCountSpan.textContent = newAcertos;
        errosCountSpan.textContent = newErros;

        // Atualiza o botão de conclusão do módulo
        if (newAcertos >= MIN_ACERTOS) {
            finishButtonContainer.innerHTML = `
                <form method="POST" action="/concluir-modulo/${MODULO_SLUG}">
                    <button type="submit" class="btn-finish hover:shadow-lg">
                        <i class="fas fa-check-double mr-2"></i>Próximo Módulo (Desbloqueado!)
                    </button>
                </form>
            `;
            showGlobalFeedback('Parabéns! Você atingiu o mínimo de acertos e desbloqueou o próximo módulo.', 'success');
        } else {
            // Se o botão estava desbloqueado (devido ao recarregamento), ele será rebloqueado
            if (!finishButtonContainer.querySelector('.btn-finish-disabled')) {
                finishButtonContainer.innerHTML = `
                    <button type="button" class="btn-finish-disabled bg-gray-400 text-gray-100 cursor-not-allowed">
                        <i class="fas fa-lock mr-2"></i> Próximo Módulo (Requer ${MIN_ACERTOS} acertos)
                    </button>
                `;
            }
        }
    }

    // Função para exibir mensagem global de feedback (sucesso/erro)
    function showGlobalFeedback(message, type) {
        globalFeedbackDiv.textContent = message;
        globalFeedbackDiv.className = `mt-3 p-2 rounded text-white font-medium ${feedbackClasses[type] || feedbackClasses['info']}`;
        globalFeedbackDiv.style.display = 'block';
        // Opcional: esconder a mensagem após X segundos
        setTimeout(() => { globalFeedbackDiv.style.display = 'none'; }, 8000);
    }

    // Função PRINCIPAL para submeter a resposta do exercício via fetch
    function submitExercise(questionId, selectedAnswer, element) {
        // Verifica se a questão já foi respondida (se o onclick foi removido)
        if (!element.onclick) {
            return;
        }
        
        const feedbackDiv = document.getElementById(`feedback-${questionId}`);
        const block = element.closest('.exercise-block');

        // Desabilitar todas as opções de resposta para esta questão
        const options = block.querySelectorAll('.quiz-option');
        options.forEach(opt => {
            opt.onclick = null; // Desabilita o clique para evitar múltiplas submissões
            opt.classList.add('pointer-events-none');
        });

        // Adiciona um indicador de "processando"
        feedbackDiv.className = `feedback-message mt-4 p-2 rounded bg-blue-100 text-blue-700`;
        feedbackDiv.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Verificando...';
        feedbackDiv.style.display = 'block';
        
        const url = `/submeter-exercicio/${MODULO_SLUG}`;

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                question_id: questionId,
                resposta: selectedAnswer,
            }),
        })
        .then(response => response.json())
        .then(data => {
            let message = '';
            
            // Define o rationale específico, que idealmente viria do backend, mas é hardcoded aqui para o frontend:
            const rationales = {
                'q-mod3-1': {
                    'A': 'A decomposição já quebrou o problema; o padrão serve para encontrar similaridades, não para re-dividir.',
                    'B': 'Correto! Padrões permitem a criação de uma solução única e genérica (abstração) que pode ser aplicada a todas as subtarefas semelhantes.',
                    'C': 'A Abstração lida com detalhes irrelevantes. O Padrão busca semelhanças.',
                    'D': 'Algoritmos é o próximo passo. O padrão é a ponte entre a decomposição e a abstração/algoritmo.'
                },
                'q-mod3-2': {
                    'A': 'Isso é Decomposição/Gestão, não o uso do padrão (erro comum).',
                    'B': 'Essa é uma resposta individualizada, não uma otimização sistêmica baseada no padrão do erro.',
                    'C': 'A Abstração viria depois, o padrão exige uma ação focada no erro recorrente.',
                    'D': 'Correto! Ao notar que o erro é comum, o professor aplica uma solução centralizada (revisão da fórmula) que aborda o ponto fraco de forma eficiente.'
                },
                'q-mod3-3': {
                    'A': 'Decomposição é a fase anterior.',
                    'B': 'Algoritmos é o último pilar.',
                    'C': 'Correto! Padrões são o insumo que a Abstração usa para criar o modelo simplificado, eliminando as diferenças.',
                    'D': 'Otimização é um resultado, não o pilar.'
                },
                'q-mod3-4': {
                    'A': 'O padrão não tem a ver com a forma física (quadra).',
                    'B': 'Estrutural foca em composição, não em desempenho em função de tempo/local.',
                    'C': 'Correto! O padrão está ligado ao dia da semana (tempo) e ao local (comportamento da equipe sob estas condições).',
                    'D': 'Embora seja um anti-padrão (resultado negativo), a categoria do padrão é temporal/comportamental.'
                },
                'q-mod3-5': {
                    'A': 'Isso é Raciocínio Heurístico (um aspecto do PC, mas não o foco do pilar).',
                    'B': 'O foco no irrelevante é a Abstração.',
                    'C': 'Isso é o Algoritmo.',
                    'D': 'Correto! Reconhecimento de Padrões foca em identificar elementos repetidos para simplificar o esforço de solução.'
                }
            };
            
            const rationale = rationales[questionId][selectedAnswer];
            
            // Verifica o status de acerto
            if (data.is_correct) {
                message = `✅ Correto! ${rationale}`;
                feedbackDiv.className = `feedback-message mt-4 p-2 rounded bg-green-100 text-green-700`;
                element.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                element.classList.add('bg-green-300');
            } else {
                message = `❌ Incorreto. ${rationale}`;
                feedbackDiv.className = `feedback-message mt-4 p-2 rounded bg-red-100 text-red-700`;
                element.classList.remove('bg-gray-100', 'hover:bg-gray-200');
                element.classList.add('bg-red-300');
            }
            
            // Atualiza o progresso global (Acertos / Erros) e o botão
            updateProgressUI(data.new_acertos, data.new_erros);
            
            // Exibe o feedback específico da questão
            feedbackDiv.innerHTML = message;

            // Se for incorreto, o usuário ainda pode tentar outra opção
            if (!data.is_correct) {
                options.forEach(opt => {
                    // Reativa a opção se for diferente da que foi clicada
                    if (opt !== element) {
                        const answerLetter = opt.getAttribute('data-answer');
                        opt.onclick = () => submitExercise(questionId, answerLetter, opt);
                        opt.classList.remove('pointer-events-none');
                    }
                });
            }

        })
        .catch(error => {
            console.error('Erro na submissão do exercício:', error);
            feedbackDiv.innerHTML = 'Erro de comunicação. Tente novamente.';
            feedbackDiv.className = `feedback-message mt-4 p-2 rounded bg-red-100 text-red-700`;
            // Reabilita as opções em caso de erro de rede
            options.forEach(opt => {
                const answerLetter = opt.getAttribute('data-answer');
                opt.onclick = () => submitExercise(questionId, answerLetter, opt);
                opt.classList.remove('pointer-events-none');
            });
        });
    }

    // Função para submeter a ideia de projeto via fetch
    function handleProjectIdeaSubmission(event, moduloSlug) {
        event.preventDefault();
        
        const ideaInput = document.getElementById('project_idea_2'); // ID ajustado para corresponder ao novo módulo
        const submitBtn = document.getElementById('projectSubmitBtn');
        const feedbackDiv = document.getElementById('projectFeedback');
        
        const idea = ideaInput.value.trim();
        
        if (!idea) {
            feedbackDiv.innerHTML = 'Por favor, descreva o padrão identificado no seu projeto antes de salvar.';
            feedbackDiv.className = 'mt-2 p-2 rounded bg-red-100 text-red-700';
            feedbackDiv.style.display = 'block';
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Salvando...';

        const url = `/salvar-projeto-modulo/${moduloSlug}`;
        
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                resposta: idea,
                campo: MODULO_SLUG // O campo no DB é 'rec_padrao'
            }),
        })
        .then(response => response.json())
        .then(data => {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Salvar Padrão';

            feedbackDiv.innerHTML = data.message;
            feedbackDiv.className = `mt-2 p-2 rounded ${data.success ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`;
            feedbackDiv.style.display = 'block';
            
            // Opcional: esconder a mensagem após X segundos
            setTimeout(() => { feedbackDiv.style.display = 'none'; }, 5000);
        })
        .catch(error => {
            console.error('Erro ao salvar ideia:', error);
            feedbackDiv.innerHTML = 'Erro de comunicação ao salvar o padrão. Tente novamente.';
            feedbackDiv.className = 'mt-2 p-2 rounded bg-red-100 text-red-700';
            feedbackDiv.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Salvar Padrão';
        });
    }

</script>
{% endblock custom_scripts %}
